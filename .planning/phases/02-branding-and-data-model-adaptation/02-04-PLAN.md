---
phase: 02-branding-and-data-model-adaptation
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - front-end/package.json
  - front-end/src/components/CsvImporter/DonorCsvImporter.tsx
  - front-end/src/components/CsvExporter/DonorCsvExporter.tsx
  - front-end/src/components/PdfExporter/ReportPdfExporter.tsx
  - front-end/src/features/dashboard/users/components/DonorImportButton.tsx
  - front-end/src/features/dashboard/overview/projects/ProjectsTableWidget.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can upload a CSV file and import donor records into the system"
    - "Admin can click an export button and download donor data as CSV"
    - "Admin can generate a PDF report of dashboard data"
    - "CSV import shows validation feedback before submitting"
    - "Export buttons are visible on the donors list page and overview page"
  artifacts:
    - path: "front-end/src/components/CsvImporter/DonorCsvImporter.tsx"
      provides: "CSV file upload and parsing component for donor import"
      contains: "CSVReader"
    - path: "front-end/src/components/CsvExporter/DonorCsvExporter.tsx"
      provides: "CSV download component for donor data export"
      contains: "CSVLink"
    - path: "front-end/src/components/PdfExporter/ReportPdfExporter.tsx"
      provides: "PDF generation component for report export"
      contains: "jsPDF"
  key_links:
    - from: "front-end/src/components/CsvImporter/DonorCsvImporter.tsx"
      to: "front-end/src/features/dashboard/users/components/DonorImportButton.tsx"
      via: "component import"
      pattern: "import.*DonorCsvImporter"
    - from: "front-end/package.json"
      to: "front-end/src/components/CsvImporter/DonorCsvImporter.tsx"
      via: "react-papaparse dependency"
      pattern: "react-papaparse"
---

<objective>
Add CSV import/export and PDF report generation capabilities for donor data management and dashboard reporting.

Purpose: Enables admins to bulk-import donor records from CSV files (DATA-03), export donor lists and adoption data to CSV (DASH-05), and generate PDF reports of dashboard metrics (DASH-05). These are the primary data management tools for the operations team.
Output: Working CSV import component, CSV export component, PDF export component, integrated into donor management and overview pages.
</objective>

<execution_context>
@/Users/ludovicgoutel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ludovicgoutel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-branding-and-data-model-adaptation/02-RESEARCH.md

Key existing files:
@front-end/package.json
@front-end/src/app/[locale]/dashboard/users/all/page.tsx
@front-end/src/app/[locale]/dashboard/page.tsx
@front-end/src/features/dashboard/overview/projects/ProjectsTableWidget.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CSV/PDF libraries and create import/export components</name>
  <files>
    front-end/package.json
    front-end/src/components/CsvImporter/DonorCsvImporter.tsx
    front-end/src/components/CsvExporter/DonorCsvExporter.tsx
    front-end/src/components/PdfExporter/ReportPdfExporter.tsx
  </files>
  <action>
1. Install dependencies in front-end directory:
   cd front-end && npm install react-papaparse react-csv jspdf html2canvas --legacy-peer-deps
   Also install types: npm install -D @types/react-csv --legacy-peer-deps

2. Create front-end/src/components/CsvImporter/DonorCsvImporter.tsx:
   - Use 'use client' directive
   - Import { useCSVReader } from 'react-papaparse'
   - Import Button from '@/components/ui/button'
   - Import { IconUpload } from '@tabler/icons-react'
   - Create DonorCsvImporter component that:
     a. Uses CSVReader with config: { header: true, skipEmptyLines: true }
     b. On upload, validates required columns (First Name, Last Name, Email)
     c. Shows a preview table of first 5 rows before import
     d. Shows validation errors (missing email, duplicate emails) with count
     e. Has "Import" button that sends validated data to the existing backend POST /api/users endpoint (adapt field names: first_name, last_name, email, phone)
     f. Shows success/error toast via react-toastify
     g. Accepts onImportComplete callback prop to refresh the donors list
   - Export as default and named export

3. Create front-end/src/components/CsvExporter/DonorCsvExporter.tsx:
   - Use 'use client' directive
   - Import { CSVLink } from 'react-csv'
   - Import Button from '@/components/ui/button'
   - Import { IconDownload } from '@tabler/icons-react'
   - Create DonorCsvExporter component that:
     a. Accepts donors array prop with fields: name, email, phone, country, lifetimeGiving, adoptionCount, joinedDate
     b. Defines CSV headers mapping labels to keys
     c. Generates filename with date: donors-YYYY-MM-DD.csv
     d. Wraps CSVLink in a styled Button with download icon
   - Export as default and named export

4. Create front-end/src/components/PdfExporter/ReportPdfExporter.tsx:
   - Use 'use client' directive
   - Import jsPDF and html2canvas
   - Import Button from '@/components/ui/button'
   - Import { IconFileTypePdf } from '@tabler/icons-react'
   - Create ReportPdfExporter component that:
     a. Accepts targetId prop (DOM element ID to capture)
     b. Accepts filename prop (default: 'coral-gardeners-report')
     c. On click, uses html2canvas to capture the target element
     d. Creates A4 landscape PDF with the captured image
     e. Adds header "Coral Gardeners Operations Report" and date
     f. Shows loading state during generation
     g. Auto-downloads the PDF
   - Export as default and named export

IMPORTANT: Use --legacy-peer-deps for npm install to avoid dependency conflicts (as noted in 01-01-SUMMARY.md). All components must use 'use client' directive since they use browser APIs.
  </action>
  <verify>
    - grep "react-papaparse" front-end/package.json should match
    - grep "react-csv" front-end/package.json should match
    - grep "jspdf" front-end/package.json should match
    - ls front-end/src/components/CsvImporter/DonorCsvImporter.tsx should exist
    - ls front-end/src/components/CsvExporter/DonorCsvExporter.tsx should exist
    - ls front-end/src/components/PdfExporter/ReportPdfExporter.tsx should exist
    - grep "CSVReader" front-end/src/components/CsvImporter/DonorCsvImporter.tsx should match
    - grep "CSVLink" front-end/src/components/CsvExporter/DonorCsvExporter.tsx should match
    - grep "jsPDF" front-end/src/components/PdfExporter/ReportPdfExporter.tsx should match
  </verify>
  <done>Libraries installed, CSV import/export and PDF export components created with proper validation, preview, and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Integrate import/export into donor and overview pages</name>
  <files>
    front-end/src/features/dashboard/users/components/DonorImportButton.tsx
    front-end/src/features/dashboard/overview/projects/ProjectsTableWidget.tsx
  </files>
  <action>
1. First, read the existing donors (users) page at front-end/src/app/[locale]/dashboard/users/all/page.tsx and the users header component to understand where to add the import button. Look for the header/toolbar area where "Create User" button is.

2. Read front-end/src/features/dashboard/ to find the users feature components. Look for:
   - A header component with action buttons (likely in features/dashboard/users/ or similar)
   - The users table component
   - Any existing export functionality

3. Create front-end/src/features/dashboard/users/components/DonorImportButton.tsx:
   - Wrapper component that imports DonorCsvImporter
   - Uses a Dialog/Sheet from shadcn/ui to show the CSV import interface
   - Includes a trigger button "Import CSV" with upload icon
   - Passes onImportComplete to refresh the page data

4. Integrate the import button into the existing donors list page:
   - Find the header/action bar component for the users/all page
   - Add DonorImportButton next to the existing "Add Donor" (Create User) button
   - Also add DonorCsvExporter next to it, passing the current donors data

5. Read front-end/src/features/dashboard/overview/projects/ProjectsTableWidget.tsx and check if it already has export functionality (the i18n overview file has export keys). If it already has export, just verify it works. If not, add a DonorCsvExporter for the adoptions table data.

6. Check if the ExportButton component at front-end/src/components/ExportButton already handles image export. If so, add the PdfExporter alongside it on the dashboard overview page, OR update the ExportButton to include PDF as an option.

IMPORTANT: Read existing components first before modifying. Preserve existing functionality. Add import/export as ADDITIONAL features, don't replace existing buttons.

NOTE: If you cannot find the exact header component to modify (the codebase structure may vary), create the integration components and add TODO comments for wiring. The key deliverable is the components existing and being importable.
  </action>
  <verify>
    - ls front-end/src/features/dashboard/users/components/DonorImportButton.tsx should exist
    - grep "DonorCsvImporter\|DonorCsvExporter" front-end/src/features/dashboard/users/components/DonorImportButton.tsx should match
    - The donors list page has access to import/export functionality
    - No existing buttons or features removed
  </verify>
  <done>CSV import button integrated into donors list page, CSV export available for donor data, PDF export component available for dashboard reports</done>
</task>

</tasks>

<verification>
1. npm install completed without errors (--legacy-peer-deps)
2. All 3 component files exist under front-end/src/components/
3. DonorImportButton wrapper exists and imports CsvImporter
4. No existing functionality broken
5. Components use 'use client' directive
6. All imports resolve correctly
</verification>

<success_criteria>
- react-papaparse, react-csv, jspdf, html2canvas are in package.json dependencies
- CSV import component parses files with header detection and shows validation
- CSV export component generates downloadable CSV with donor data columns
- PDF export component captures DOM element and generates downloadable PDF
- Import button accessible from donors management page
- Export buttons accessible from donors list and overview pages
- No existing features or buttons removed
</success_criteria>

<output>
After completion, create `.planning/phases/02-branding-and-data-model-adaptation/02-04-SUMMARY.md`
</output>
